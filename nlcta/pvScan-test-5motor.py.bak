#!/usr/bin/env python
# For doing DAQ scans.  Logs PV data to a file while doing beam scan. Uses a supporting IOC (pvScan).
# mdunning 1/7/16

from epics import caget,caput,PV
from time import sleep
import datetime,os,sys
from threading import Thread

args='PV_PREFIX'

def show_usage():
    "Prints usage"
    print 'Usage: %s %s' %(sys.argv[0], args)

if len(sys.argv) != 2:
    show_usage()
    sys.exit(1)

# PV prefix for pvScan IOC; should be passed as an argument
pvPrefix=sys.argv[1]
# Set an environment variable for so pvScan module can use it
os.environ['PVSCAN_PVPREFIX']=pvPrefix

# Import pvScan module
sys.path.append('/afs/slac/g/testfac/extras/scripts/pvScan/R2.0/modules/')
import pvScan

# Motors
motor1='ESB:XPS1:m3:MOTR'  # Motor 1 actual PV (UED pitch motor)
motor1Pv=PV(motor1) # Motor position PV object
motor1RBVPv=PV(motor1 + '.RBV') # Motor position RBV PV object
motor1Start=PV(pvPrefix + ':MOTOR1:START').get()  # for scanning
motor1Stop=PV(pvPrefix + ':MOTOR1:STOP').get()  # for scanning
motor1NSteps=PV(pvPrefix + ':MOTOR1:NSTEPS').get()  # for scanning
motor1Offset=PV(pvPrefix + ':MOTOR1:OFFSET').get()  # for scanning
#
motor2='ESB:XPS1:m6:MOTR'  # Motor 2 actual PV (UED Y motor)
motor2Pv=PV(motor2) # Motor position PV object
motor2RBVPv=PV(motor2 + '.RBV') # Motor position RBV PV object
motor2Start=PV(pvPrefix + ':MOTOR2:START').get()  # for scanning
motor2Stop=PV(pvPrefix + ':MOTOR2:STOP').get()  # for scanning
motor2NSteps=PV(pvPrefix + ':MOTOR2:NSTEPS').get()  # for scanning
motor2Offset=PV(pvPrefix + ':MOTOR2:OFFSET').get()  # for scanning
#
motor3='ESB:XPS1:m7:MOTR'  # Motor 3 actual PV (UED Z motor)
motor3Pv=PV(motor3) # Motor position PV object
motor3RBVPv=PV(motor3 + '.RBV') # Motor position RBV PV object
motor3Start=PV(pvPrefix + ':MOTOR3:START').get()  # for scanning
motor3Stop=PV(pvPrefix + ':MOTOR3:STOP').get()  # for scanning
motor3NSteps=PV(pvPrefix + ':MOTOR3:NSTEPS').get()  # for scanning
motor3Offset=PV(pvPrefix + ':MOTOR3:OFFSET').get()  # for scanning
#
motor4='ESB:XPS1:m4:MOTR'  # Motor 4 actual PV (UED X motor)
motor4Pv=PV(motor4) # Motor position PV object
motor4RBVPv=PV(motor4 + '.RBV') # Motor position RBV PV object
#
motor5='ESB:XPS2:m1:MOTR'  # Motor 5 actual PV (UED Delay motor)
motor5Pv=PV(motor5) # Motor position PV object
motor5RBVPv=PV(motor5 + '.RBV') # Motor position RBV PV object
# Shutters/stoppers/screens
shutter1EnablePv=PV('ESB:GP01:VAL01')
shutter2EnablePv=PV('ESB:GP01:VAL02')
shutter3EnablePv=PV('ESB:GP01:VAL03')
shutter1DisablePv=PV('ESB:GP01:VAL01')
shutter2DisablePv=PV('ESB:GP01:VAL02')
shutter3DisablePv=PV('ESB:GP01:VAL03')
# ADC values
#lsrpwrPv=PV('ESB:A01:ADC1:AI:CH3')
#toroid0355Pv=PV('ESB:A01:ADC1:AI:CH4')
#toroid2150Pv=PV('ESB:A01:ADC1:AI:CH5')
#structureChargePv=PV('ESB:A01:ADC1:CALC:CH1:CONV')

pause1=1.0  # sec

#---- For data logging --------------------------
pvList=[shutter1EnablePv,shutter2EnablePv,shutter3EnablePv,motor1RBVPv,motor2RBVPv,motor3RBVPv,motor4RBVPv,motor5RBVPv] # list of PVs to be monitored during scan
expName=PV(pvPrefix + ':IOC.DESC').get()
if ' ' in expName: expName=expName.replace(' ','_')
now=datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
filepath=os.environ['NFSHOME'] + '/pvScan/' + expName + '/' + now + '/'
if not os.path.exists(filepath): os.makedirs(filepath)
filepathPv=PV(pvPrefix + ':DATA:FILEPATH')
filepathPv.put(filepath)  # Write filepath to PV for display
dataFilename=filepath + now + '.dat'
dataFilenamePv=PV(pvPrefix + ':DATA:FILENAME')
dataFilenamePv.put(dataFilename)
logFilename=filepath + now + '.log'
logFilenamePv=PV(pvPrefix + ':LOG:FILENAME')
logFilenamePv.put(logFilename)
dataEnable=PV(pvPrefix + ':DATA:ENABLE').get()  # Enable/Disable data logging
dataInt=PV(pvPrefix + ':DATA:INT').get()  # Interval between PV data log points
nPtsMax=100000  # limits number of data points
#-------------------------------------------------

# --- For grabbing images --------------------------
grabImagesFlag=PV(pvPrefix + ':GRABIMAGES:ENABLE').get()
grabImagesN=PV(pvPrefix + ':GRABIMAGES:N').get()
grabImagesFilepath=filepath + 'images/'
grabImagesPlugin='TIFF1'
grabImagesSource='13PS10'
#-------------------------------------------------------------

# --- For UED  --------------------------
resetFlag=PV(pvPrefix + ':RESET:ENABLE').get()
radius=PV(pvPrefix + ':RADIUS').get()
resetMotorPv=motor1Pv
nResets=PV((pvPrefix + ':NRESETS').get()
#-------------------------------------------------------------

####################################################################################################

def scanRoutine():
    "This is the scan routine"
    print pvScan.timestamp(1), 'Starting'
    pvScan.msgPv.put('Starting')
    sleep(pause1)
    # block laser
    #print pvScan.timestamp(1), 'Blocking laser'
    #laserShutter1Pv.put(0)
    #laserShutter2Pv.put(0)  # just in case
    # remove profile monitor screen
    #print pvScan.timestamp(1), 'Removing screen'
    #screenPv.put(0)
    # Scan delay stage and grab images...
    #pvScan.motor1DScan(motor1Pv,motor1Start,motor1Stop,motor1RBVPv,motor1NSteps,grabImagesFlag,grabImagesN,grabImagesSource,grabImagesFilepath,grabImagesPlugin,grabImagesFilenameExtras='',settleTime=0.5)
    pvScan.uedDaeMotorScan(motor1Pv,motor1RBVPv,motor1Start,motor1Stop,motor1NSteps,motor1Offset,motor2Pv,motor2RBVPv,motor2Offset,motor3Pv,motor3RBVPv,motor3Offset,radius,resetFlag,shutter1TTLEnablePv,shutter2TTLEnablePv,shutter3TTLEnablePv,shutter1TTLDisablePv,shutter2TTLDisablePv,shutter3TTLDisablePv,resetMotorPv,grabImagesFlag,nResets,grabImagesSource,grabImagesFilepath,grabImagesPlugin,grabImagesFilenameExtras='',settleTime=0.5)
    # block laser
    #print pvScan.timestamp(1), 'Blocking laser'
    #laserShutter1Pv.put(0)
    #laserShutter2Pv.put(0)  # just in case
    print pvScan.timestamp(1), 'Done'
    pvScan.msgPv.put('Done')

    
    

if __name__ == "__main__":
    "Do scan routine; log PV data to file as a separate thread if enabled"
    pvScan.Tee(logFilename, 'w')
    pvScan.dataFlag=1  # start logging data
    if dataEnable==1:
        datalogthread=Thread(target=pvScan.datalog,args=(dataInt,dataFilename,pvList,nPtsMax))
        datalogthread.start()
    scanRoutine()
    sleep(pause1)
    pvScan.dataFlag=0  # stop logging data

        
##################################################################################################################
        

exit

